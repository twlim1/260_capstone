{% extends "base.html" %}
{%- block content -%}

<!-- =============== Sandbox Inputs =============== -->
<div id="sandboxContainer">
    <div id="sandboxInput" class="form-group shadow-textarea">
        <h5><label for="inputTextarea">Security-related Text:</label></h5>
        <textarea class="form-control z-depth-1" id="inputTextarea" rows="3" placeholder="Enter text here..."></textarea>
    </div>

    <div style="line-height:50%;"><br></div>

    <div>
        <button id="inputButton" type="button" class="button button-md radius-10">Evaluate</button>
        <span>&nbsp;&nbsp;&nbsp;</span>
        <span id="inputNotificationZone"></span>
    </div>

    <div style="line-height:200%;"><br></div>

    <div id="sandboxOutput" class="form-group shadow-textarea">
        <h5><label for="outputTextarea">Output:</label></h5>
        <p class="form-control z-depth-1" id="outputTextarea" rows="3" readonly></p>
    </div>
</div>

<!-- ==================== JS ==================== -->
<script>
    document.getElementById('inputButton').onclick = submitText;

    function msgUser(text) {
        let ele = document.getElementById('inputNotificationZone');

        /* message is already present...maybe user is spam clicking */
        if (ele.textContent !== undefined && ele.textContent !== "") {
            return;
        }

        ele.style.opacity = 1;
        ele.textContent = text;

        setTimeout(clearMsg, 5000);
    }

    /* Fades out the box that displays messages */
    function clearMsg() {
        let ele = document.getElementById('inputNotificationZone');

        let timerId = setInterval(function() {
            var opacity = ele.style.opacity;

            /* last iteration */
            if (opacity <= 0) {
                clearInterval(timerId);
                ele.textContent = '';

            /* most iterations */
            } else {
                ele.style.opacity = opacity - 0.03;
            }
        }, 50);
    }

    /* Landing zone for starting an api request */
    function submitText() {
        let value = document.getElementById('inputTextarea').value;

        if (value === undefined || value === '') {
            msgUser('Need input text!');
            return;
        }

        makeApiRequest(value);
    }

    /* Sends text to our api */
    function makeApiRequest(text) {
        let req = new XMLHttpRequest();
        let url = 'getprediction';
        let params = `text=${text}`;

        req.open('POST', url, true); // true == asynchronous 
        req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

        req.onreadystatechange = function() { 
            if (req.readyState == 4 && req.status == 200) {
                processResponse(req.responseText);
            }
        }
        req.send(params);
    }

    function convertOutput(data, key) {
        if (key === 'pred_av') {
                 if (data[key] === 0) { return 'Network'; }
            else if (data[key] === 1) { return 'Adjacent Network'; }
            else if (data[key] === 2) { return 'Local'; }
            else if (data[key] === 3) { return 'Physical'; }
            else { return 'Unknown'; }

        } else if (key === 'pred_ac') {
                 if (data[key] === 0) { return 'Low'; }
            else if (data[key] === 1) { return 'High'; }
            else { return 'Unknown'; }

        } else if (key === 'pred_ui') {
                 if (data[key] === 0) { return 'None'; }
            else if (data[key] === 1) { return 'Required'; }
            else { return 'Unknown'; }

        } else if (key === 'pred_sc') {
                 if (data[key] === 0) { return 'Unchanged'; }
            else if (data[key] === 1) { return 'Changed'; }
            else { return 'Unknown'; }

        } else if (key === 'pred_pr'  ||
                   key === 'pred_ci'  ||
                   key === 'pred_ii'  ||
                   key === 'pred_ai') {
                 if (data[key] === 0) { return 'None'; }
            else if (data[key] === 1) { return 'Low'; }
            else if (data[key] === 2) { return 'High'; }
            else { return 'Unknown'; }
        }
    }

    /* Update text box */
    function showResponse(text) {
        document.getElementById('outputTextarea').innerHTML = text;
    }

    function processResponse(text) {
        let output;
        try {
            output = JSON.parse(text);
        }
        catch (e) {
            showResponse('Could not parse:<br>' + text);
            return;
        }

        let disp_html = '<strong>CVSS Base Score:</strong> ' + output['score_b'] + '<br><br>';

        disp_html += '<strong>Attack Vector:</strong> '         + convertOutput(output, 'pred_av') + '<br>';
        disp_html += '<strong>Attack Complexity:</strong> '     + convertOutput(output, 'pred_ac') + '<br>';
        disp_html += '<strong>Privileges Required:</strong> '   + convertOutput(output, 'pred_pr') + '<br>';
        disp_html += '<strong>User Interaction:</strong> '      + convertOutput(output, 'pred_ui') + '<br>';
        disp_html += '<strong>Scope:</strong> '                 + convertOutput(output, 'pred_sc') + '<br>';
        disp_html += '<strong>Confidentiality Impact:</strong> '+ convertOutput(output, 'pred_ci') + '<br>';
        disp_html += '<strong>Integrity Impact:</strong> '      + convertOutput(output, 'pred_ii') + '<br>';
        disp_html += '<strong>Availablity Impact:</strong> '    + convertOutput(output, 'pred_ai') + '<br><br>';

        disp_html += '<strong>Mean Confidence:</strong> ' + Number(output['mean_conf']).toFixed(2) + '<br>';

        showResponse(disp_html);
    }
</script>

{%- endblock -%}
